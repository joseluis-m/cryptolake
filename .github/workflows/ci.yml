# ============================================================
# CI Pipeline — CryptoLake
# ============================================================
# Se ejecuta en cada PR y push a main/develop.
#
# Jobs:
# 1. lint       → Verifica formato y estilo de código
# 2. test       → Ejecuta tests unitarios con pytest
# 3. dbt-test   → Compila modelos dbt (verifica SQL)
# 4. docker-build → Verifica que todas las imágenes Docker construyen
#
# Diagrama de dependencias:
#   lint → test    ─┐
#   lint → dbt-test ├─→ docker-build
#                   ─┘
# ============================================================
name: CI Pipeline

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  # ──────────────────────────────────────────────────────────
  # JOB 1: Linting
  # ──────────────────────────────────────────────────────────
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linters
        run: pip install ruff mypy

      - name: Ruff check (linting)
        run: ruff check src/ tests/

      - name: Ruff format (formatting)
        run: ruff format --check src/ tests/

  # ──────────────────────────────────────────────────────────
  # JOB 2: Unit Tests
  # ──────────────────────────────────────────────────────────
  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run tests with coverage
        run: pytest tests/unit/ -v --cov=src --cov-report=xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: coverage.xml
        continue-on-error: true

  # ──────────────────────────────────────────────────────────
  # JOB 3: dbt Compile
  # ──────────────────────────────────────────────────────────
  # No ejecutamos dbt run (necesitaría Spark Thrift Server),
  # pero sí compilamos para verificar que el SQL es válido.
  # ──────────────────────────────────────────────────────────
  dbt-test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dbt
        run: pip install "dbt-core>=1.8" "dbt-spark[PyHive]>=1.8"

      - name: dbt compile
        run: |
          cd src/transformation/dbt_cryptolake
          dbt compile --profiles-dir . --target ci

  # ──────────────────────────────────────────────────────────
  # JOB 4: Docker Build
  # ──────────────────────────────────────────────────────────
  docker-build:
    runs-on: ubuntu-latest
    needs: [test, dbt-test]
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Build all Docker images
        run: |
          docker compose build --parallel
          echo "✅ All images built successfully"
