# ============================================================
# CI Pipeline â€” CryptoLake
# ============================================================
# Runs on every PR to main/develop and on push to main.
#
# Jobs:
# 1. lint         Verify code style and formatting (ruff)
# 2. test         Run unit tests with pytest + coverage
# 3. dbt-test     Compile dbt models (validates SQL syntax)
# 4. docker-build Verify all Docker images build successfully
#
# Dependency graph:
#   lint -> test     -+
#   lint -> dbt-test -+-> docker-build
# ============================================================

name: CI Pipeline

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  # -- Linting -----------------------------------------------
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linters
        run: pip install ruff mypy

      - name: Ruff check (linting)
        run: ruff check src/ tests/

      - name: Ruff format (formatting)
        run: ruff format --check src/ tests/

  # -- Unit Tests --------------------------------------------
  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run tests with coverage
        run: pytest tests/unit/ -v --cov=src --cov-report=xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: coverage.xml
        continue-on-error: true

  # -- dbt Compile -------------------------------------------
  # Compiles SQL models to verify syntax without running them
  # (running would require a live Spark Thrift Server).
  dbt-test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dbt
        run: pip install "dbt-core>=1.8" "dbt-spark[PyHive]>=1.8"

      - name: dbt compile
        run: |
          cd src/transformation/dbt_cryptolake
          dbt compile --profiles-dir . --target ci

  # -- Docker Build ------------------------------------------
  docker-build:
    runs-on: ubuntu-latest
    needs: [test, dbt-test]
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Build all Docker images
        run: |
          docker compose build --parallel
          echo "All images built successfully"
